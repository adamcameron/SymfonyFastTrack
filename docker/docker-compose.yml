version: "3"
services:
    nginx:
        build:
            context: .
            dockerfile: nginx/Dockerfile

        ports:
            - "8062:80"

        stdin_open: true
        tty: true

        volumes:
            - ../public:/usr/share/nginx/html/

        depends_on:
            - php

        networks:
            - backend

    php:
        build:
            context: .
            dockerfile: php/Dockerfile

        env_file:
            - php/envVars.private
            - php/envVars.public

        stdin_open: true
        tty: true

        volumes:
            - ..:/var/www

        networks:
            - backend

    nodejs:
        build:
            context: .
            dockerfile: nodejs/Dockerfile

        stdin_open: true
        tty: true

        volumes:
            - ..:/usr/share/nodejs/

    postgres-primary:
        build:
            context: .
            dockerfile: postgres-primary/Dockerfile

        env_file:
            - postgres-primary/envVars.private
            - postgres-primary/envVars.public

        ports:
            - "5432:5432"

        volumes:
            - postgres-primary-data:/var/lib/postgresql/data

        stdin_open: true
        tty: true

        networks:
            backend:
                aliases:
                    - database-primary.backend

    postgres-replica:
        build:
            context: .
            dockerfile: postgres-replica/Dockerfile

        env_file:
            - postgres-replica/envVars.private
            - postgres-replica/envVars.public

        ports:
            - "5433:5433"

        command: -p 5433

        volumes:
            - postgres-replica-data:/var/lib/postgresql/data

        stdin_open: true
        tty: true

        networks:
            backend:
                aliases:
                    - database-replica.backend

    mailer:
        build:
            context: .
            dockerfile: mailer/Dockerfile
        ports:
            - 1025
            - 1080

    blackfire:
        build:
            context: .
            dockerfile: blackfire/Dockerfile

        env_file:
            - blackfire/envVars.private

        environment:
            BLACKFIRE_LOG_LEVEL: 4

        stdin_open: true
        tty: true

        ports:
            - 8307

volumes:
    postgres-primary-data:
    postgres-replica-data:

networks:
    backend:
        driver: "bridge"
